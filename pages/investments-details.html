<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investments Analysis | AI Impact</title>
    
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/pages.css"> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* Page Specific Styles to ensure Map visibility */
        #map {
            height: 700px;
            width: 100%;
            border-radius: 12px;
            background-color: #0e0e0e; /* Fallback */
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .legend {
            background-color: rgba(14, 14, 14, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            line-height: 1.5;
            font-size: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .legend i {
            width: 12px;
            height: 12px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
            border-radius: 50%;
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 8px;
            display: block;
            font-size: 14px;
            color: #4cc9f0;
        }

        /* Tooltip customization */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 20, 20, 0.95);
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
        }
        .leaflet-popup-tip {
            background: rgba(20, 20, 20, 0.95);
        }
        .leaflet-popup-content b {
            color: #4cc9f0;
        }
    </style>
</head>
<body class="subpage-body">

    <nav class="subpage-nav">
        <a href="../index.html#section-investment" class="back-link">
            <span>←</span> Back to Main Analysis
        </a>
    </nav>

    <div class="container">
        
        <header class="page-header">
            <h1>Global Data Center Investments</h1>
            <p>Mapping the physical infrastructure of AI. Bubble size represents capital cost (Billions USD).</p>
        </header>

        <div class="chart-section">
            <div id="map"></div>
        </div>

        <div class="chart-analysis">
            <p>
                The rendered map depicts a highly centralized pattern of capital investment in data center infrastructure. A pronounced concentration of high-value 
                facilities is evident within the United States, where large and overlapping markers representing the major technology firms—Microsoft, Google, Amazon, 
                and Meta—indicate substantial and concurrent investment activity. Outside the United States, a notably large data center categorized as “Other” is 
                observed in East Asia. The scale of this facility suggests a significant capital outlay, likely attributable to regional technology providers or state-backed 
                entities. In contrast, the Middle East is represented by only a minor investment, while regions such as South America, Africa, and Australia exhibit minimal 
                or no presence of high-capital data centers within the scope of this dataset. The spatial overlap of investments in the United States implies the formation 
                of infrastructure clusters, wherein multiple firms co-locate large-scale facilities to capitalize on established electrical grids, fiber-optic networks, and 
                related logistical advantages. Overall, the distribution underscores the extent to which contemporary AI and data infrastructure development is dominated by 
                a small number of highly capitalized multinational corporations.
            </p>
        </div>

    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    //  Map configuration
    const map = L.map('map', {
        center: [20, 0],
        zoom: 2,
        minZoom: 2,
        maxBounds: [[-90, -180], [90, 180]],
        maxBoundsViscosity: 1.0
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        noWrap: true
    }).addTo(map);

    const csvPath = "../data/data_centers/data_centers.csv";

d3.csv(csvPath).then(data => {
        // Helper to find columns
        const getColName = (obj, target) => {
            return Object.keys(obj).find(k => k.trim().toLowerCase().includes(target.toLowerCase()));
        };

        // 1. Identify Columns
        const colLat = getColName(data[0], "latitude");
        const colLng = getColName(data[0], "longitude");
        const colOwner = getColName(data[0], "owner");
        const colCost = getColName(data[0], "capital cost");
        // We look for "title" (or "Name" if title isn't found, as a fallback)
        const colTitle = getColName(data[0], "title") || getColName(data[0], "name"); 

        const cleanData = data.filter(d => {
            const latStr = d[colLat] ? d[colLat].trim() : "";
            const lngStr = d[colLng] ? d[colLng].trim() : "";
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);
            return !isNaN(lat) && !isNaN(lng) && Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
        }).map(d => {
            // --- GEOMETRY FIX (From previous step) ---
            const latStr = d[colLat].trim().toUpperCase();
            const lngStr = d[colLng].trim().toUpperCase();
            let lat = parseFloat(latStr);
            let lng = parseFloat(lngStr);

            if (lngStr.includes("W")) lng = -Math.abs(lng);
            if (latStr.includes("S")) lat = -Math.abs(lat);

            // --- DATA CLEANING (New Request) ---
            
            // 1. Clean Owner: Remove "likely" and "confident" (case insensitive)
            let ownerRaw = d[colOwner] || "Other";
            let ownerClean = ownerRaw
                .replace(/#likely/gi, "")
                .replace(/#confident/gi, "")
                .trim();

            // 2. Handle Cost
            let costRaw = parseFloat(d[colCost]);
            // If it's NaN, treat as 0 for logic purposes
            if (isNaN(costRaw)) costRaw = 0;

            return {
                title: d[colTitle] || "Data Center", // Get the Title
                owner: ownerClean,                   // Use cleaned owner
                lat: lat,
                lng: lng,
                cost: costRaw,                       // Keep the number for radius calculation
                //location: d[colLoc] || "Unknown" // Assuming colLoc is defined in scope or you can re-declare it
            };
        });

        // --- COLORS (HIGH CONTRAST, REQUESTED PALETTE) ---
        const brandColors = {
            "Microsoft": "#ff0000", // red
            "Google": "#0000ff",    // blue
            "Amazon": "#00ff00",    // green
            "Meta": "#ffff00",      // yellow
            "Other": "#ffffff"      // white
        };

        const getColor = (owner) => {
            const key = Object.keys(brandColors).find(k => owner.includes(k));
            return key ? brandColors[key] : brandColors.Other;
        };


        // Scale: domain starts at 0, but we want 0 to still be visible (small dot)
        const radiusScale = d3.scaleSqrt()
            .domain([0, d3.max(cleanData, d => d.cost)]) 
            .range([4, 25]); // Minimum size 4px so 0-cost items are visible

        // --- DRAWING ---
        cleanData.forEach(point => {
            
            // Determine Text for Cost
            let costDisplay;
            if (point.cost === 0) {
                costDisplay = "Unknown";
            } else {
                costDisplay = point.cost.toFixed(2); // e.g. "5.50"
            }

            const tooltipContent = `
                <div style="
                    background: rgba(20,20,20,0.95);
                    color: #ffffff;
                    padding: 8px 10px;
                    border: 1px solid #444;
                    border-radius: 4px;
                    text-align: left;
                    font-family: Inter, sans-serif;
                ">
                    <div style="font-size:14px; font-weight:700; margin-bottom:4px;">
                        ${point.title}
                    </div>
                    <div style="font-size:12px; color:#cccccc;">
                        ${point.owner}
                    </div>
                    <div style="
                        margin-top:6px;
                        padding-top:6px;
                        border-top:1px solid #444;
                        font-weight:700;
                        color:#4cc9f0;
                    ">
                        ${costDisplay === "Unknown" ? "Unknown" : `$${costDisplay} Billion`}
                    </div>
                </div>
            `;


            L.circleMarker([point.lat, point.lng], {
                radius: radiusScale(point.cost),
                fillColor: getColor(point.owner),
                color: "#fff",
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.6
            })
            // CHANGE: Use bindTooltip instead of bindPopup
            .bindTooltip(tooltipContent, {
                permanent: false,   // Show only on hover
                direction: 'top',   // Appears above the bubble
                className: 'custom-tooltip', // Uses the CSS we added above
                opacity: 1
            })
            .addTo(map);
        });

        // --- LEGEND (Keep existing legend logic) ---
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<span class="legend-title">Owner</span>';
            // We'll just show the main brands manually since the "clean" owners might be too many
            const mainBrands = ["Microsoft", "Google", "Amazon", "Meta", "Other"];
            
            mainBrands.forEach(brand => {
                div.innerHTML += `<div><i style="background:${brandColors[brand] || '#888888'}"></i>${brand}</div>`;
            });
            return div;
        };
        legend.addTo(map);

    }).catch(error => {
        console.error("Errore caricamento CSV:", error);
    });
</script>
</body>
</html>