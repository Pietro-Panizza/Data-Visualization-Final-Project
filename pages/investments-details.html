<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investments Analysis | AI Impact</title>
    
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/pages.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* --- MAP STYLES --- */
        #map {
            height: 700px;
            width: 100%;
            border-radius: 12px;
            background-color: #0e0e0e; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1;
            margin-bottom: 30px;
        }

        .legend {
            background-color: rgba(14, 14, 14, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            line-height: 1.5;
            font-size: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .legend i {
            width: 12px;
            height: 12px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
            border-radius: 50%;
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 8px;
            display: block;
            font-size: 14px;
            color: #4cc9f0;
        }

        /* Tooltip customization */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 20, 20, 0.95);
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
        }
        .leaflet-popup-tip {
            background: rgba(20, 20, 20, 0.95);
        }

        /* Analysis text section */
        .analysis-text {
            background-color: rgba(20, 20, 20, 0.7);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .analysis-text h3 {
            color: #4cc9f0;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .analysis-text p {
            margin-bottom: 15px;
            font-size: 1.05em;
        }
        
        .analysis-text p:last-child {
            margin-bottom: 0;
        }

        /* --- PIE CHART STYLES --- */
        #pie-chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 600px;
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.02);
            padding: 10px;
            border-radius: 8px;
        }

        .toggle-group {
            display: inline-flex;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 3px;
        }

        .toggle-btn {
            background: transparent;
            border: none;
            color: #aaa;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #4a90e2;
            color: white;
        }

        .btn-back {
            background: transparent;
            border: 1px solid #64ffda;
            color: #64ffda;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .btn-back:hover {
            background: rgba(100, 255, 218, 0.1);
        }

        path.slice {
            cursor: pointer;
            stroke: #0a192f;
            stroke-width: 2px;
            transition: opacity 0.3s;
        }
        path.slice:hover {
            opacity: 0.8;
            stroke: #fff;
        }
    </style>
</head>
<body class="subpage-body">

    <nav class="subpage-nav">
        <a href="../index.html#section-investment" class="back-link">
            <span>←</span> Back to Main Analysis
        </a>
    </nav>

    <div class="container">
        
        <header class="page-header">
            <h1>Global AI Investments</h1>
            <p>Analyzing the financial landscape of Artificial Intelligence through physical infrastructure and model training costs.</p>
        </header>

        <div class="chart-section">
            <h2>1. Global Data Center Investments</h2>
            <p>The map below shows the world's largest data centers dedicated to artificial intelligence, which are facilities dedicated to processing large amounts of data. Specifically, they are used primarily to train new models and run real-time inference on existing models.<br><br>
            
            Each bubble represents one of the largest data centers in the world. The size of the bubbles indicates the amount of money invested in building the facility, while the color indicates the investing company.</p>
            
            <div id="map"></div>
        </div>

        <div class="chart-analysis">
            <p>
                The rendered map depicts a highly centralized pattern of capital investment in data center infrastructure. A pronounced concentration of high-value 
                facilities is evident within the United States, where large and overlapping markers representing the major technology firms—Microsoft, Google, Amazon, 
                and Meta—indicate substantial and concurrent investment activity. Outside the United States, a notably large data center categorized as “Other” is 
                observed in East Asia. The scale of this facility suggests a significant capital outlay, likely attributable to regional technology providers or state-backed 
                entities. In contrast, the Middle East is represented by only a minor investment, while regions such as South America, Africa, and Australia exhibit minimal 
                or no presence of high-capital data centers within the scope of this dataset. The spatial overlap of investments in the United States implies the formation 
                of infrastructure clusters, wherein multiple firms co-locate large-scale facilities to capitalize on established electrical grids, fiber-optic networks, and 
                related logistical advantages. Overall, the distribution underscores the extent to which contemporary AI and data infrastructure development is dominated by 
                a small number of highly capitalized multinational corporations.
            </p>
        </div>

    </div>

    <footer class="page-footer">
        <div class="footer-content">
            <p>Source 1: <a href="https://epoch.ai/data/data-centers?view=table" target="_blank" rel="noopener">epoch.ai/data/data-centers</a></p>
            <p>Source 2: <a href="https://epoch.ai/data/ai-models" target="_blank" rel="noopener">epoch.ai/data/ai-models</a></p>
        </div>
    </footer>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    //  Map configuration
    const map = L.map('map', {
        center: [20, 0],
        zoom: 2,
        minZoom: 2,
        maxBounds: [[-90, -180], [90, 180]],
        maxBoundsViscosity: 1.0
    });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            noWrap: true
        }).addTo(map);

        const csvPathMap = "../data/data_centers/data_centers.csv";

        d3.csv(csvPathMap).then(data => {
            const getColName = (obj, target) => {
                return Object.keys(obj).find(k => k.trim().toLowerCase().includes(target.toLowerCase()));
            };

            const colLat = getColName(data[0], "latitude");
            const colLng = getColName(data[0], "longitude");
            const colOwner = getColName(data[0], "owner");
            const colCost = getColName(data[0], "capital cost");
            const colTitle = getColName(data[0], "title") || getColName(data[0], "name"); 

            const cleanData = data.filter(d => {
                const latStr = d[colLat] ? d[colLat].trim() : "";
                const lngStr = d[colLng] ? d[colLng].trim() : "";
                const lat = parseFloat(latStr);
                const lng = parseFloat(lngStr);
                return !isNaN(lat) && !isNaN(lng) && Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
            }).map(d => {
                let lat = parseFloat(d[colLat]);
                let lng = parseFloat(d[colLng]);
                if (d[colLng].includes("W")) lng = -Math.abs(lng);
                if (d[colLat].includes("S")) lat = -Math.abs(lat);

                let ownerRaw = d[colOwner] || "Other";
                let ownerClean = ownerRaw.replace(/#likely/gi, "").replace(/#confident/gi, "").trim();
                let costRaw = parseFloat(d[colCost]);
                if (isNaN(costRaw)) costRaw = 0;

                return {
                    title: d[colTitle] || "Data Center",
                    owner: ownerClean,
                    lat: lat,
                    lng: lng,
                    cost: costRaw
                };
            });

            const brandColors = {
                "Microsoft": "#ff0000",
                "Google": "#0000ff",
                "Amazon": "#00ff00",
                "Meta": "#ffff00",
                "Other": "#ffffff"
            };

            const getColor = (owner) => {
                const key = Object.keys(brandColors).find(k => owner.includes(k));
                return key ? brandColors[key] : brandColors.Other;
            };

            const radiusScale = d3.scaleSqrt()
                .domain([0, d3.max(cleanData, d => d.cost)]) 
                .range([4, 25]);

            cleanData.forEach(point => {
                let costDisplay = point.cost === 0 ? "Unknown" : point.cost.toFixed(2);
                
                const tooltipContent = `
                    <div style="font-family:Inter; color:white;">
                        <b>${point.title}</b><br>
                        <span style="color:#ccc">${point.owner}</span><br>
                        <span style="color:#4cc9f0; font-weight:bold;">${costDisplay === "Unknown" ? "Unknown" : `$${costDisplay} Billion`}</span>
                    </div>
                `;

                L.circleMarker([point.lat, point.lng], {
                    radius: radiusScale(point.cost),
                    fillColor: getColor(point.owner),
                    color: "#fff",
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                })
                .bindTooltip(tooltipContent, {
                    permanent: false,
                    direction: 'top',
                    className: 'custom-tooltip',
                    opacity: 1
                })
                .addTo(map);
            });

            // Legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function () {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML += '<span class="legend-title">Owner</span>';
                const mainBrands = ["Microsoft", "Google", "Amazon", "Meta", "Other"];
                mainBrands.forEach(brand => {
                    div.innerHTML += `<div><i style="background:${brandColors[brand] || '#888888'}"></i>${brand}</div>`;
                });
                return div;
            };
            legend.addTo(map);

        }).catch(error => {
            console.error("Errore caricamento CSV Mappa:", error);
        });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const width = 800;
        const height = 600;
        const radius = Math.min(width, height) / 2 - 60;

        let currentData = [];
        let viewState = 'main'; // 'main' or 'detail'
        let groupBy = 'Organization'; 
        let selectedEntity = null;

        const svg = d3.select("#pie-chart-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        const color = d3.scaleOrdinal(d3.schemeSet3);

        // Path to Models Data (Assumed ../data or ../../data based on folder structure)
        // Since HTML is in pages/, we go up one level to root, then into data.
        const csvPathModels = "../data/ai_models/all_ai_models.csv"; 

        d3.csv(csvPathModels).then(data => {
            
            const getCol = (row, ...attempts) => {
                const keys = Object.keys(row);
                for (let attempt of attempts) {
                    const found = keys.find(k => k.toLowerCase().includes(attempt.toLowerCase()));
                    if (found) return found;
                }
                return null;
            };

            const colCost = getCol(data[0], "Training compute cost", "cost");
            const colOrg = getCol(data[0], "Organization");
            const colCountry = getCol(data[0], "Country");
            const colModel = getCol(data[0], "System", "Model");

            const cleanStr = (str) => {
                if (!str) return "Unknown";
                return str.replace(/[\[\]']/g, "").split(",")[0].trim();
            };

            const cleanData = data.map(d => {
                let cost = parseFloat(d[colCost]);
                if (isNaN(cost)) cost = 0;

                return {
                    model: d[colModel] || "Unnamed Model",
                    organization: cleanStr(d[colOrg]),
                    country: cleanStr(d[colCountry]),
                    cost: cost
                };
            }).filter(d => d.cost > 0 && d.organization !== "Unknown");

            currentData = cleanData;
            updateChart();

            d3.select("#btn-org").on("click", () => setGrouping('Organization'));
            d3.select("#btn-country").on("click", () => setGrouping('Country'));
            d3.select("#btn-back").on("click", () => goBack());

        }).catch(err => {
            console.error("Pie Chart Data Error:", err);
            d3.select("#pie-chart-container").html("<p style='color:red'>Error loading data. Check console for path issues.</p>");
        });

        function setGrouping(group) {
            groupBy = group;
            viewState = 'main';
            selectedEntity = null;
            d3.select("#btn-org").classed("active", group === 'Organization');
            d3.select("#btn-country").classed("active", group === 'Country');
            d3.select("#btn-back").style("display", "none");
            updateChart();
        }

        function goBack() {
            viewState = 'main';
            selectedEntity = null;
            d3.select("#btn-back").style("display", "none");
            updateChart();
        }

        function updateChart() {
            let processedData = [];
            let centerTitle = "";
            let centerSubtitle = "";

            if (viewState === 'main') {
                const keyField = groupBy === 'Organization' ? 'organization' : 'country';
                const rollup = d3.rollups(currentData, v => d3.sum(v, d => d.cost), d => d[keyField]);
                const totalCost = d3.sum(rollup, d => d[1]);

                let sorted = rollup.sort((a, b) => b[1] - a[1]);
                let otherSum = 0;
                
                sorted.forEach(([key, value]) => {
                    if (value / totalCost < 0.02) {
                        otherSum += value;
                    } else {
                        processedData.push({ key: key, value: value, type: 'group' });
                    }
                });

                if (otherSum > 0) {
                    processedData.push({ key: "Other", value: otherSum, type: 'other' });
                }

                centerTitle = "Total Investment";
                centerSubtitle = d3.format("$,.2s")(totalCost).replace('G', 'B');

            } else {
                const keyField = groupBy === 'Organization' ? 'organization' : 'country';
                const filtered = currentData.filter(d => d[keyField] === selectedEntity);
                
                processedData = filtered.map(d => ({
                    key: d.model,
                    value: d.cost,
                    type: 'model'
                })).sort((a, b) => b.value - a.value);

                const totalEntityCost = d3.sum(processedData, d => d.value);
                centerTitle = selectedEntity;
                centerSubtitle = d3.format("$,.2s")(totalEntityCost).replace('G', 'B');
            }

            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(radius * 0.55).outerRadius(radius);
            const arcHover = d3.arc().innerRadius(radius * 0.55).outerRadius(radius * 1.05);

            const slices = svg.selectAll("path.slice")
                .data(pie(processedData), d => d.data.key);

            slices.enter()
                .append("path")
                .attr("class", "slice")
                .attr("fill", d => {
                    if(d.data.key === "Other") return "#444";
                    return color(d.data.key);
                })
                .attr("d", arc)
                .each(function(d) { this._current = d; })
                .merge(slices)
                .on("mouseover", function(event, d) {
                    if (viewState === 'main' && d.data.type === 'other') return; 
                    
                    d3.select(this).transition().duration(200).attr("d", arcHover);
                    
                    const percent = ((d.endAngle - d.startAngle) / (2 * Math.PI)) * 100;
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`
                        <strong>${d.data.key}</strong><br>
                        $${d3.format(",.2s")(d.data.value).replace('G','B')}<br>
                        ${percent.toFixed(1)}%
                    `)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).transition().duration(200).attr("d", arc);
                    tooltip.transition().duration(200).style("opacity", 0);
                })
                .on("click", function(event, d) {
                    if (viewState === 'main' && d.data.type !== 'other') {
                        selectedEntity = d.data.key;
                        viewState = 'detail';
                        d3.select("#btn-back").style("display", "inline-flex");
                        updateChart();
                    }
                })
                .transition().duration(750)
                .attrTween("d", function(d) {
                    const i = d3.interpolate(this._current, d);
                    this._current = i(0);
                    return t => arc(i(t));
                });

            slices.exit().remove();

            svg.selectAll(".center-text").remove();
            
            svg.append("text")
                .attr("class", "center-text")
                .attr("dy", "-0.5em")
                .style("text-anchor", "middle")
                .style("fill", "#888")
                .style("font-size", "14px")
                .text(viewState === 'main' ? `Total by ${groupBy}` : "Total Cost");

            svg.append("text")
                .attr("class", "center-text")
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("fill", "#fff")
                .style("font-size", "22px")
                .style("font-weight", "bold")
                .text(centerTitle);

            svg.append("text")
                .attr("class", "center-text")
                .attr("dy", "2.5em")
                .style("text-anchor", "middle")
                .style("fill", "#4cc9f0")
                .style("font-size", "16px")
                .text(centerSubtitle);
        }
    });
    </script>
</body>
</html>